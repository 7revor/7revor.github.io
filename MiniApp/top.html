<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>思路 | 7revor</title>
    <meta name="description" content="可爱又迷人的反派角色">
    <link rel="icon" href="/docs/img/favicon.ico">
    
    <link rel="preload" href="/docs/assets/css/0.styles.58531315.css" as="style"><link rel="preload" href="/docs/assets/js/app.4ab28825.js" as="script"><link rel="preload" href="/docs/assets/js/19.e006c669.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.c09cb538.js"><link rel="prefetch" href="/docs/assets/js/11.19268fa3.js"><link rel="prefetch" href="/docs/assets/js/12.c0fee833.js"><link rel="prefetch" href="/docs/assets/js/13.2259e511.js"><link rel="prefetch" href="/docs/assets/js/14.66e6b874.js"><link rel="prefetch" href="/docs/assets/js/15.32a4e212.js"><link rel="prefetch" href="/docs/assets/js/16.41377d65.js"><link rel="prefetch" href="/docs/assets/js/17.754c29fe.js"><link rel="prefetch" href="/docs/assets/js/18.fdefc283.js"><link rel="prefetch" href="/docs/assets/js/2.ad5bf1e0.js"><link rel="prefetch" href="/docs/assets/js/20.d0150c72.js"><link rel="prefetch" href="/docs/assets/js/21.9b51a425.js"><link rel="prefetch" href="/docs/assets/js/22.210a9e28.js"><link rel="prefetch" href="/docs/assets/js/23.72f62196.js"><link rel="prefetch" href="/docs/assets/js/24.6c17a689.js"><link rel="prefetch" href="/docs/assets/js/25.78548d72.js"><link rel="prefetch" href="/docs/assets/js/26.c13a0274.js"><link rel="prefetch" href="/docs/assets/js/27.4d1478b2.js"><link rel="prefetch" href="/docs/assets/js/28.48ec91ca.js"><link rel="prefetch" href="/docs/assets/js/29.7b1a6e61.js"><link rel="prefetch" href="/docs/assets/js/3.746bb0c2.js"><link rel="prefetch" href="/docs/assets/js/30.e84731d6.js"><link rel="prefetch" href="/docs/assets/js/31.b006719c.js"><link rel="prefetch" href="/docs/assets/js/32.14570730.js"><link rel="prefetch" href="/docs/assets/js/33.ea66e4b8.js"><link rel="prefetch" href="/docs/assets/js/34.c535b5ab.js"><link rel="prefetch" href="/docs/assets/js/35.4a956201.js"><link rel="prefetch" href="/docs/assets/js/36.3d4335b6.js"><link rel="prefetch" href="/docs/assets/js/37.b972a2d7.js"><link rel="prefetch" href="/docs/assets/js/38.866f9b42.js"><link rel="prefetch" href="/docs/assets/js/39.731e50bb.js"><link rel="prefetch" href="/docs/assets/js/4.378f37ca.js"><link rel="prefetch" href="/docs/assets/js/40.6786aa28.js"><link rel="prefetch" href="/docs/assets/js/5.0e492c21.js"><link rel="prefetch" href="/docs/assets/js/6.2bf23e83.js"><link rel="prefetch" href="/docs/assets/js/7.5dbbe719.js"><link rel="prefetch" href="/docs/assets/js/8.d5f186c7.js"><link rel="prefetch" href="/docs/assets/js/9.cf172365.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.58531315.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">7revor</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/MiniApp/miniapp.html" class="sidebar-link">商家应用知识点梳理</a></li><li><a href="/docs/MiniApp/hack.html" class="sidebar-link">无侵入式运营对接方案</a></li><li><a href="/docs/MiniApp/frame.html" class="sidebar-link">全局统一交互实现</a></li><li><a href="/docs/MiniApp/navigate.html" class="sidebar-link">导航功能扩展</a></li><li><a href="/docs/MiniApp/top.html" class="active sidebar-link">授权接口调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MiniApp/top.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/top.html#创建云函数" class="sidebar-link">创建云函数</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/top.html#区分top调用方式" class="sidebar-link">区分top调用方式</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/top.html#配置环境变量" class="sidebar-link">配置环境变量</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/top.html#手动获取sessionkey并存储" class="sidebar-link">手动获取sessionKey并存储</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h2 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h2> <p>大体思路为云函数调用top接口可以手动传递session参数。</p> <h2 id="创建云函数"><a href="#创建云函数" class="header-anchor">#</a> 创建云函数</h2> <p><code>top/index.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> data<span class="token punctuation">,</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>topApi<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  
            api<span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>data<span class="token punctuation">,</span>
                session
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> data<span class="token operator">:</span> result <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> e<span class="token punctuation">.</span>message <span class="token operator">||</span> e <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在云端拿到本地传递的 topApi 名称，参数，以及用户session，对请求做转发。</p> <h2 id="区分top调用方式"><a href="#区分top调用方式" class="header-anchor">#</a> 区分top调用方式</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * TOP 基层调用(本地)
 * @param {string} api api名称
 * @param {string} data 参数
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">topNative</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> cloud<span class="token punctuation">.</span>topApi<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token operator">:</span> result <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> e<span class="token punctuation">.</span>sub_msg <span class="token operator">||</span> e<span class="token punctuation">.</span>msg <span class="token operator">||</span> e <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// parse e.message 失败</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> error <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * TOP 基层调用（云函数）
 * @param  {string} name 函数名
 * @param  {object} data 参数
 * @param  {string} handler 云函数的handler
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">topCloud</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  option<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>sessionKey<span class="token punctuation">;</span> <span class="token comment">// 获取sessionKey</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>option<span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'云函数top接口调用需为 app.globalData 配置 sessionkey 参数！'</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> cloud<span class="token punctuation">.</span>function<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'top'</span><span class="token punctuation">,</span> option<span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token function">topCloudResultFormat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> msg <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> msg<span class="token punctuation">.</span>sub_msg <span class="token operator">||</span> msg<span class="token punctuation">.</span>msg <span class="token operator">||</span> msg <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> e<span class="token punctuation">.</span>message <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里要注意一点，本地调用top返回的数据格式没有嵌套的情况，而通过云函数调用，返回数据会像QAP中一样有嵌套的情况出现：</p> <p>比如我用云函数请求商品详情，获取的部分信息如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>item<span class="token operator">:</span><span class="token punctuation">{</span>
    skus<span class="token operator">:</span><span class="token punctuation">{</span>
        sku<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// 这里是sku数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    item_imgs<span class="token operator">:</span><span class="token punctuation">{</span>
        item_img<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// 这里是图片数据</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而使用本地直接请求top，返回的数据如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>item<span class="token operator">:</span><span class="token punctuation">{</span>
    skus<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 这里直接是sku数据</span>
    item_imgs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// 这里直接是图片数据</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以这里就需要我们对云端返回的数据格式做转换，方法如下（可能不太完善，如果有发现另外的嵌套情况需补充逻辑）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 将云函数top接口返回信息统一转换为本地格式
 */</span>
<span class="token keyword">function</span> <span class="token function">topCloudResultFormat</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> warn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'[object Object]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                             <span class="token comment">// 参数为标准js对象</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>          <span class="token comment">// 遍历对象key</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>                                  <span class="token comment">// 取出value</span>
        <span class="token keyword">const</span> value_type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断value类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value_type <span class="token operator">===</span> <span class="token string">'[object Object]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token comment">// 嵌套对象</span>
          <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 取出嵌套对象值</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'s'</span> <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token operator">||</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// 嵌套case</span>
            warn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'['</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'] 作为嵌套对象被转换'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 消除嵌套</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token operator">?</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token operator">?</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'[object Array]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// 数组</span>
      <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> element <span class="token operator">?</span> <span class="token function">transform</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">:</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>   <span class="token comment">// undefined,boolean,string,number,function,null,Date,RegExp,function,Symbol</span>
      <span class="token keyword">return</span> data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>warn<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">info</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <p>该方法应该可以涵盖90%的情况，上线前还需要切换为本地调用并使用真机调试对数据格式进行最后的确认。</p></div> <h2 id="配置环境变量"><a href="#配置环境变量" class="header-anchor">#</a> 配置环境变量</h2> <p><code>app.json</code>新增配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
   
    <span class="token string">&quot;topEnv&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cloud&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// 云函数调用top接口，</span>
 <span class="token comment">// &quot;topEnv&quot;: &quot;native&quot;,  // 本地直接调用top接口</span>
  
<span class="token punctuation">}</span>
</code></pre></div><p><code>base.js</code>入口文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'/app.json'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * TOP 基层调用
 * @param {string} api api名称
 * @param {string} data 参数
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">top</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> topEnv <span class="token operator">=</span> config<span class="token punctuation">.</span>topEnv <span class="token operator">||</span> <span class="token string">'native'</span><span class="token punctuation">;</span> <span class="token comment">// 获取top接口调用模式，默认为本地，模拟器下配置为 cloud</span>
  <span class="token keyword">return</span> topEnv <span class="token operator">===</span> <span class="token string">'cloud'</span><span class="token operator">?</span><span class="token keyword">await</span> <span class="token function">topCloud</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token operator">:</span><span class="token keyword">await</span> <span class="token function">topNative</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="手动获取sessionkey并存储"><a href="#手动获取sessionkey并存储" class="header-anchor">#</a> 手动获取sessionKey并存储</h2> <p>打开真机调试，获取授权信息后将session保存在globalData中以便接口取用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  globalData<span class="token operator">:</span> <span class="token punctuation">{</span>
    sessionKey<span class="token operator">:</span><span class="token string">&quot;手动复制到此处保存（有效期最短应该也得有一天）&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/21/2019, 7:30:27 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/MiniApp/navigate.html" class="prev">
          导航功能扩展
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/docs/assets/js/app.4ab28825.js" defer></script><script src="/docs/assets/js/19.e006c669.js" defer></script>
  </body>
</html>
