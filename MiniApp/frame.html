<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>背景 | 7revor</title>
    <meta name="description" content="可爱又迷人的反派角色">
    <link rel="icon" href="/docs/img/favicon.ico">
    
    <link rel="preload" href="/docs/assets/css/0.styles.58531315.css" as="style"><link rel="preload" href="/docs/assets/js/app.4ab28825.js" as="script"><link rel="preload" href="/docs/assets/js/15.32a4e212.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.c09cb538.js"><link rel="prefetch" href="/docs/assets/js/11.19268fa3.js"><link rel="prefetch" href="/docs/assets/js/12.c0fee833.js"><link rel="prefetch" href="/docs/assets/js/13.2259e511.js"><link rel="prefetch" href="/docs/assets/js/14.66e6b874.js"><link rel="prefetch" href="/docs/assets/js/16.41377d65.js"><link rel="prefetch" href="/docs/assets/js/17.754c29fe.js"><link rel="prefetch" href="/docs/assets/js/18.fdefc283.js"><link rel="prefetch" href="/docs/assets/js/19.e006c669.js"><link rel="prefetch" href="/docs/assets/js/2.ad5bf1e0.js"><link rel="prefetch" href="/docs/assets/js/20.d0150c72.js"><link rel="prefetch" href="/docs/assets/js/21.9b51a425.js"><link rel="prefetch" href="/docs/assets/js/22.210a9e28.js"><link rel="prefetch" href="/docs/assets/js/23.72f62196.js"><link rel="prefetch" href="/docs/assets/js/24.6c17a689.js"><link rel="prefetch" href="/docs/assets/js/25.78548d72.js"><link rel="prefetch" href="/docs/assets/js/26.c13a0274.js"><link rel="prefetch" href="/docs/assets/js/27.4d1478b2.js"><link rel="prefetch" href="/docs/assets/js/28.48ec91ca.js"><link rel="prefetch" href="/docs/assets/js/29.7b1a6e61.js"><link rel="prefetch" href="/docs/assets/js/3.746bb0c2.js"><link rel="prefetch" href="/docs/assets/js/30.e84731d6.js"><link rel="prefetch" href="/docs/assets/js/31.b006719c.js"><link rel="prefetch" href="/docs/assets/js/32.14570730.js"><link rel="prefetch" href="/docs/assets/js/33.ea66e4b8.js"><link rel="prefetch" href="/docs/assets/js/34.c535b5ab.js"><link rel="prefetch" href="/docs/assets/js/35.4a956201.js"><link rel="prefetch" href="/docs/assets/js/36.3d4335b6.js"><link rel="prefetch" href="/docs/assets/js/37.b972a2d7.js"><link rel="prefetch" href="/docs/assets/js/38.866f9b42.js"><link rel="prefetch" href="/docs/assets/js/39.731e50bb.js"><link rel="prefetch" href="/docs/assets/js/4.378f37ca.js"><link rel="prefetch" href="/docs/assets/js/40.6786aa28.js"><link rel="prefetch" href="/docs/assets/js/5.0e492c21.js"><link rel="prefetch" href="/docs/assets/js/6.2bf23e83.js"><link rel="prefetch" href="/docs/assets/js/7.5dbbe719.js"><link rel="prefetch" href="/docs/assets/js/8.d5f186c7.js"><link rel="prefetch" href="/docs/assets/js/9.cf172365.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.58531315.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">7revor</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/MiniApp/miniapp.html" class="sidebar-link">商家应用知识点梳理</a></li><li><a href="/docs/MiniApp/hack.html" class="sidebar-link">无侵入式运营对接方案</a></li><li><a href="/docs/MiniApp/frame.html" class="active sidebar-link">全局统一交互实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#改善" class="sidebar-link">改善</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#集成-frame" class="sidebar-link">集成 frame</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/frame.html#交互方法注入" class="sidebar-link">交互方法注入</a></li></ul></li></ul></li><li><a href="/docs/MiniApp/navigate.html" class="sidebar-link">导航功能扩展</a></li><li><a href="/docs/MiniApp/top.html" class="sidebar-link">授权接口调用</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>在小程序框架中，my API 提供了全局的 alert，toast 等交互组件。使用起来也比较方便。唯一的遗憾是我们无法更改它的样式，只能用官方自带的效果。这显然和我们的UI体系格格不入。</p> <p>因此，定制交互组件就十分有必要了。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>现在我们写一个简单的 dialog 组件，来处理我们的 alert 消息：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>py-dialog {{visible?'active':''}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   {{content}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    visible<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
      * 提示
      */</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>visible<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token punctuation">,</span>
        visible<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$resolve <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 确定事件
     */</span>
    <span class="token function">sure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$resolve <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// promise resolve</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 弹窗关闭</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 关闭弹窗
     */</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        visible<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$resolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里封装 dialog 的思路还是和之前 React 中一样，借助 Promise 来实现简洁的交互。<a href="/docs/React/Dialog.html">传送门</a></p> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <p>下面我们来使用一下这个 dialog 组件：</p> <p>首先在 page.json 中声明：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;usingComponents&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;dialog&quot;</span><span class="token operator">:</span><span class="token string">&quot;./components/dialog/dialog&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于无法获取 document 来动态插入内容，所以使用组件需要 axml 中显示引入：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">onTap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>点我弹窗<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dialog</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dialog<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们需要借助 ref 来获取页面中的组件实例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">dialog</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 首先保存该弹窗实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$dialog <span class="token operator">=</span> ref<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>呼起弹窗：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 点击事件</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$dialog<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'提示！'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，我们要想使用自己封装的这个 dialog，需要经过四步。</p> <ul><li>在 page.json 中声明</li> <li>在 axml 中引入</li> <li>在 js 中保存组件实例</li> <li>通过组件实例调用</li></ul> <p>这还只是一个dialog。如果后续加上 toast，actionSheet 等交互，那么每个页面都需要引入三个组件，保存三次组件实例。
并且在子组件中使用交互，还需要先获取页面实例，再呼起页面中的 dialog。</p> <p>这完全违背了我们的初衷。交互组件的目的就是为了简单、快捷的实现交互功能。</p> <h2 id="改善"><a href="#改善" class="header-anchor">#</a> 改善</h2> <h3 id="集成-frame"><a href="#集成-frame" class="header-anchor">#</a> 集成 frame</h3> <p>首先将所有的交互组件集成到名为 frame 的组件中，将各个交互组件实例都维护在 frame 里，由 frame 统一调用，这样我们只需要引入 frame 就可以使用所有的交互。</p> <h4 id="frame实现"><a href="#frame实现" class="header-anchor">#</a> frame实现</h4> <div class="language-vue extra-class"><pre class="language-vue"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dialog</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_dialog<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>toast</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_toast<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action-sheet</span> <span class="token attr-name"><span class="token namespace">a:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{select}}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_action_sheet<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>由于并不是所有页面都要用到 ActionSheet，所以我们把 ActionSheet 作为可选配置。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$page<span class="token punctuation">,</span> <span class="token string">'$inject_frame'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">_pyDialog</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 挂载弹窗到frame</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$page<span class="token punctuation">.</span>$inject_frame<span class="token punctuation">,</span> <span class="token string">'dialog'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> ref
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">_toast</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 挂载toast到frame</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$page<span class="token punctuation">.</span>$inject_frame<span class="token punctuation">,</span> <span class="token string">'toast'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> ref
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">_action_sheet</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 挂载select到frame</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$page<span class="token punctuation">.</span>$inject_frame<span class="token punctuation">,</span> <span class="token string">'action_sheet'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> ref
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>frame 做了如下工作：</p> <ul><li>初始化时，在当前页面对象上创建一个名为 <code>$inject_frame</code> 的引用，指向其自身</li> <li>各个子组件初始化时将实例绑定到页面对象上的 <code>$inject_frame</code> 中</li></ul> <h3 id="交互方法注入"><a href="#交互方法注入" class="header-anchor">#</a> 交互方法注入</h3> <p>有了集成 frame，我们可以通过 <code>page.$inject_frame</code> 来实现对交互组件的统一管理。但调用起来还是比较繁琐：</p> <ul><li>调用 alert，我需要 <code>this.$inject_frame.dialog.alert('xxx')</code></li> <li>调用 toast，我需要 <code>this.$inject_frame.toast.toast('xxx')</code></li></ul> <p>借助上文提到的全局拦截，我们可以采取原型注入的方式将操作直接绑定到页面以及组件实例中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> old_page <span class="token operator">=</span> Page<span class="token punctuation">;</span>
<span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * frame 全局交互注入
     */</span>
    <span class="token function">frameInject</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... ...其他操作</span>
    <span class="token function">old_page</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于组件中的调用首先要获取 <code>this.$page</code>，这里我们需要做一下区分。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> old_component <span class="token operator">=</span> Component<span class="token punctuation">;</span>
<span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * frame 全局交互注入
     */</span>
    <span class="token function">frameInject</span><span class="token punctuation">(</span>prototype<span class="token punctuation">,</span> <span class="token string">'component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... ...其他操作</span>
    <span class="token function">old_component</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来看一下我们的主角 frameInject 函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * frame全局交互注入
 */</span>
<span class="token keyword">function</span> <span class="token function">frameInject</span><span class="token punctuation">(</span><span class="token parameter">prototype<span class="token punctuation">,</span> component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prototype<span class="token punctuation">.</span>Inject <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// 用来区分一下不需要注入的原型（比如交互组件自身，弹窗组件等等）</span>
  <span class="token keyword">let</span> inject_target<span class="token punctuation">;</span>  <span class="token comment">// 注入对象</span>
  <span class="token keyword">let</span> frame_index<span class="token punctuation">;</span>    <span class="token comment">// frame实例位置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 组件注入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prototype<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prototype<span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    inject_target <span class="token operator">=</span> prototype<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
    frame_index <span class="token operator">=</span> <span class="token string">'$page.$inject_frame'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 页面注入</span>
    inject_target <span class="token operator">=</span> prototype<span class="token punctuation">;</span>
    frame_index <span class="token operator">=</span> <span class="token string">'$inject_frame'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
    * 全局alert
    */</span>
  inject_target<span class="token punctuation">.</span><span class="token function-variable function">$alert</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> frame <span class="token operator">=</span> <span class="token function">getProperty</span><span class="token punctuation">(</span>frame_index<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'未检测到 frame ，请确保页面正确引入 frame 组件！'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> frame<span class="token punctuation">.</span>dialog<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它做了两件事</p> <ul><li>为所有的页面以及组件原型添加 $alert 方法</li> <li>调用 $alert 方法时，实际调用的是 <code>page.$inject_frame.dialog.alert</code></li></ul> <p>其他的交互API（toast等）如法炮制。</p> <p>这样一来，无论我们是在页面还是组件中，只要引入了 frame ，就可以直接通过 <code>this.$alert</code> 开心的实现交互。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/21/2019, 7:30:27 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/MiniApp/hack.html" class="prev">
          无侵入式运营对接方案
        </a></span> <span class="next"><a href="/docs/MiniApp/navigate.html">
          导航功能扩展
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/docs/assets/js/app.4ab28825.js" defer></script><script src="/docs/assets/js/15.32a4e212.js" defer></script>
  </body>
</html>
