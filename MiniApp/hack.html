<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>写在前面 | 7revor</title>
    <meta name="description" content="可爱又迷人的反派角色">
    <link rel="icon" href="/docs/img/favicon.ico">
    
    <link rel="preload" href="/docs/assets/css/0.styles.58531315.css" as="style"><link rel="preload" href="/docs/assets/js/app.4ab28825.js" as="script"><link rel="preload" href="/docs/assets/js/16.41377d65.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.c09cb538.js"><link rel="prefetch" href="/docs/assets/js/11.19268fa3.js"><link rel="prefetch" href="/docs/assets/js/12.c0fee833.js"><link rel="prefetch" href="/docs/assets/js/13.2259e511.js"><link rel="prefetch" href="/docs/assets/js/14.66e6b874.js"><link rel="prefetch" href="/docs/assets/js/15.32a4e212.js"><link rel="prefetch" href="/docs/assets/js/17.754c29fe.js"><link rel="prefetch" href="/docs/assets/js/18.fdefc283.js"><link rel="prefetch" href="/docs/assets/js/19.e006c669.js"><link rel="prefetch" href="/docs/assets/js/2.ad5bf1e0.js"><link rel="prefetch" href="/docs/assets/js/20.d0150c72.js"><link rel="prefetch" href="/docs/assets/js/21.9b51a425.js"><link rel="prefetch" href="/docs/assets/js/22.210a9e28.js"><link rel="prefetch" href="/docs/assets/js/23.72f62196.js"><link rel="prefetch" href="/docs/assets/js/24.6c17a689.js"><link rel="prefetch" href="/docs/assets/js/25.78548d72.js"><link rel="prefetch" href="/docs/assets/js/26.c13a0274.js"><link rel="prefetch" href="/docs/assets/js/27.4d1478b2.js"><link rel="prefetch" href="/docs/assets/js/28.48ec91ca.js"><link rel="prefetch" href="/docs/assets/js/29.7b1a6e61.js"><link rel="prefetch" href="/docs/assets/js/3.746bb0c2.js"><link rel="prefetch" href="/docs/assets/js/30.e84731d6.js"><link rel="prefetch" href="/docs/assets/js/31.b006719c.js"><link rel="prefetch" href="/docs/assets/js/32.14570730.js"><link rel="prefetch" href="/docs/assets/js/33.ea66e4b8.js"><link rel="prefetch" href="/docs/assets/js/34.c535b5ab.js"><link rel="prefetch" href="/docs/assets/js/35.4a956201.js"><link rel="prefetch" href="/docs/assets/js/36.3d4335b6.js"><link rel="prefetch" href="/docs/assets/js/37.b972a2d7.js"><link rel="prefetch" href="/docs/assets/js/38.866f9b42.js"><link rel="prefetch" href="/docs/assets/js/39.731e50bb.js"><link rel="prefetch" href="/docs/assets/js/4.378f37ca.js"><link rel="prefetch" href="/docs/assets/js/40.6786aa28.js"><link rel="prefetch" href="/docs/assets/js/5.0e492c21.js"><link rel="prefetch" href="/docs/assets/js/6.2bf23e83.js"><link rel="prefetch" href="/docs/assets/js/7.5dbbe719.js"><link rel="prefetch" href="/docs/assets/js/8.d5f186c7.js"><link rel="prefetch" href="/docs/assets/js/9.cf172365.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.58531315.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">7revor</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link">Documents</a></div><div class="nav-item"><a href="/docs/MiniApp/" class="nav-link router-link-active">MiniApp</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/MiniApp/miniapp.html" class="sidebar-link">商家应用知识点梳理</a></li><li><a href="/docs/MiniApp/hack.html" class="active sidebar-link">无侵入式运营对接方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#写在前面" class="sidebar-link">写在前面</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#什么是埋点" class="sidebar-link">什么是埋点</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#传统侵入式埋点" class="sidebar-link">传统侵入式埋点</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#无侵入式埋点" class="sidebar-link">无侵入式埋点</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#小程序中的埋点" class="sidebar-link">小程序中的埋点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#page-component" class="sidebar-link">Page Component</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#全局构造拦截" class="sidebar-link">全局构造拦截</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#埋点实现" class="sidebar-link">埋点实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#其他业务对接" class="sidebar-link">其他业务对接</a></li><li class="sidebar-sub-header"><a href="/docs/MiniApp/hack.html#写在最后" class="sidebar-link">写在最后</a></li></ul></li><li><a href="/docs/MiniApp/frame.html" class="sidebar-link">全局统一交互实现</a></li><li><a href="/docs/MiniApp/navigate.html" class="sidebar-link">导航功能扩展</a></li><li><a href="/docs/MiniApp/top.html" class="sidebar-link">授权接口调用</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面</h2> <p>对于一个成熟稳定的项目来讲，运营的重要性想必不用再去过多赘述。</p> <p>用户操作 app 时产生行为数据，通过数据采集系统采集，对采集的数据进行处理（实时数据处理+离线数据处理）得到统计数据进行数据分析，并将结果呈现出来以复盘总结当前版本并驱动下一个产品迭代，或者清洗后的数据进行数据挖掘，实时反馈给用户（如推荐），这是最常见不过的应用场景。</p> <p>而数据采集，是整个数据流的起点，也是重中之重。采集的全不全、对不对，直接决定数据广度和质量，影响后续所有的环节。</p> <h2 id="什么是埋点"><a href="#什么是埋点" class="header-anchor">#</a> 什么是埋点</h2> <p>所谓“埋点”，是数据采集领域（尤其是用户行为数据采集领域）的术语，指的是针对特定用户行为或事件进行捕获、处理和发送的相关技术及其实施过程。比如用户某个icon点击次数、观看某个视频的时长等等。</p> <h2 id="传统侵入式埋点"><a href="#传统侵入式埋点" class="header-anchor">#</a> 传统侵入式埋点</h2> <p>代码埋点是我们常用的客户端埋点方式。在按钮或者图片的点击事件中插入相应的埋点代码，当用户点击时，发送埋点数据。</p> <p>这是埋点最简单的实现方式，无疑也是工作量最大的。他的问题在于：</p> <ul><li>工作量大，每个埋点的地方都需要手动插入代码。</li> <li>过于分散，埋点代码存在于项目各个角落，无法统一管理。</li> <li>过于耦合，程序中插入太多业务无关代码，影响代码阅读和维护。</li></ul> <h2 id="无侵入式埋点"><a href="#无侵入式埋点" class="header-anchor">#</a> 无侵入式埋点</h2> <p>基于上述几个问题，无侵入式埋点应运而生。</p> <p>由于浏览器特殊的事件冒泡捕获机制，我们可以在 document 上对所有用户交互事件进行全局监听，从而实现无侵入式埋点：</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> ev<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-statistic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something    </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们监听所有的用户点击事件，如果该元素上含有 <code>data-statistic</code> 属性，也就是我们的埋点数据，那么进行一系列的操作。</p> <p>比如我要给一个图片添加埋点，监听它的点击量：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">data-statistic</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>图片X<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxxxxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>只需要简单的操作，就可以收集相应的埋点数据，而对业务代码没有任何影响，这就是所谓的“无侵入式埋点”。</p> <h2 id="小程序中的埋点"><a href="#小程序中的埋点" class="header-anchor">#</a> 小程序中的埋点</h2> <p>在小程序中，我们无法获取 <code>window</code> <code>document</code> 等全局对象，那么如何实现无侵入式埋点呢？</p> <h3 id="page-component"><a href="#page-component" class="header-anchor">#</a> Page Component</h3> <p>我们新建页面或者组件的时候，所有的配置都经过 Page 和 Component 构造器（暂且叫他构造器），然后才生成我们的页面对象。那么我们是不是可以对这俩对象下手呢，多说无益，来试试看。</p> <h4 id="首先看看page里有啥"><a href="#首先看看page里有啥" class="header-anchor">#</a> 首先看看Page里有啥</h4> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Page<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function(e){Object(r.a)(e)}</span>
</code></pre></div><p>可以看到，他就是一个 Function，接收一个 option (就是我们的页面配置)，生成页面实例对象。</p> <p>实际我们的页面文件完全可以这样写：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> option <span class="token operator">=</span> <span class="token punctuation">{</span>
  data<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">tapHandler</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">Page</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看到上面的书写形式，端倪出现了。既然 Page 接收的是一个 Object 对象，那么我们就可以在它接收到 option 之前，对 option 进行全局统一拦截。</p> <h3 id="全局构造拦截"><a href="#全局构造拦截" class="header-anchor">#</a> 全局构造拦截</h3> <p>我们把原本的 Page 对象替换掉，换成我们自己的 Page 对象，然后对数据进行处理后，再交给原来的 Page 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * page扩展
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pageEnhance</span><span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> old_page <span class="token operator">=</span> Page<span class="token punctuation">;</span>
  <span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 做一些拦截处理</span>
    <span class="token function">old_page</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们在调用 Page 时，实际上是先调用我们的“假Page”，然后在传递给“真Page”。</p> <h3 id="埋点实现"><a href="#埋点实现" class="header-anchor">#</a> 埋点实现</h3> <p>好消息是，小程序框架为我们提供了全局统一的 Event 事件模型，所有用户的点击，滑动等事件所携带的事件对象格式都是统一的。这就为我们的方法拦截提供了思路。</p> <h4 id="筛选携带埋点信息的方法进行特殊处理"><a href="#筛选携带埋点信息的方法进行特殊处理" class="header-anchor">#</a> 筛选携带埋点信息的方法进行特殊处理</h4> <p>上文中说到，我们在小程序事件中传递参数需要借助 dataset，那么我们暂且规定所有的埋点数据都放到 <code>data-statistic</code> 中:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">data-statistic</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>用户数据<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onTap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tapHandler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>毫无疑问，我们的 <code>tapHandler</code> 处理程序中，第一个参数肯定是事件对象，而事件对象中的 <code>currentTarget.dataset</code> 又必然包含 <code>statistic</code> 属性。</p> <p>所以对方法做一下过滤：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pageEnhance</span><span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> old_page <span class="token operator">=</span> Page<span class="token punctuation">;</span>
  <span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
     env <span class="token operator">!==</span> <span class="token string">'test'</span> <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">property</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> option<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">statisticHack</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 埋点数据收集</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token function">old_page</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 埋点统计数据
 */</span>
<span class="token keyword">function</span> <span class="token function">statisticHack</span><span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> old_func <span class="token operator">=</span> option<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 拿到原有的函数引用</span>
  option<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// 对函数进行替换</span>
    <span class="token keyword">const</span> ev <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 第一个参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>timeStamp <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'tap'</span> <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>currentTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断为点击事件</span>
      <span class="token keyword">const</span> statistic <span class="token operator">=</span>ev<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>statistic<span class="token punctuation">;</span> <span class="token comment">// 尝试获取埋点数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statistic<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 含有埋点数据</span>
        <span class="token keyword">delete</span> ev<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>statistic<span class="token punctuation">;</span> <span class="token comment">// 删除埋点数据，防止事件传递重复上报</span>
        <span class="token keyword">delete</span> ev<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>statistic<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发现埋点！'</span><span class="token punctuation">,</span> statistic<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">old_func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行原有函数逻辑</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对所有函数添加埋点检测逻辑，如果含有埋点数据，那么先进行埋点收集，如果无埋点数据，那么直接执行原有逻辑。</p> <p>这里有三点需要注意：</p> <ul><li>埋点数据收集后要马上删除。如果页面内部对该事件进行了传递（子组件，父组件或其他函数），那么会重复执行收集动作。</li> <li>函数替换时不可使用箭头函数。因为箭头函数无法正确获取函数运行时上下文（this），也就无法在执行原有函数逻辑修正this指向。</li> <li>对页面原型对象（也就是我们传入的页面属性）进行 <code>oject[property]</code> 动态查找，会导致 sourceMap 失效。不利于我们本地开发调试，所以推荐只在生产环境中开启。
也就是添加env变量。</li></ul> <h2 id="其他业务对接"><a href="#其他业务对接" class="header-anchor">#</a> 其他业务对接</h2> <p>当然不仅仅是埋点，像版本权限控制也可以这么实现。</p> <p>只需要在高级版功能入口添加像<code>data-vip=&quot;true</code>之类的参数，然后对事件进行拦截。</p> <p>当我检测到这是高级版功能，那么拉取用户版本信息进行判断。如果是高级版那么执行原有逻辑，否则进行拦截，提示用户进行订购。</p> <p>诸如此类，等等等等... ...</p> <h2 id="写在最后"><a href="#写在最后" class="header-anchor">#</a> 写在最后</h2> <p>为了防止非必要的拦截，可以对一些不需要监听的方法（诸如声明周期）配置白名单。</p> <p>当然上述只是提供一个大体思路，肯定也会有更巧妙更简洁的实现方式。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/19/2019, 1:44:58 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/MiniApp/miniapp.html" class="prev">
          商家应用知识点梳理
        </a></span> <span class="next"><a href="/docs/MiniApp/frame.html">
          全局统一交互实现
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/docs/assets/js/app.4ab28825.js" defer></script><script src="/docs/assets/js/16.41377d65.js" defer></script>
  </body>
</html>
